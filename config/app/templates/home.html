<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Residential Apartments Dashboard</title>
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #004a8b;
            --secondary-color: #002f5a;
            --background-color: #f4f7fa;
            --card-bg: white;
            --text-color: #2d3748;
            --text-light: #718096;
            --border-color: #e2e8f0;
            --blue-badge: #3182ce;
            --green-badge: #38a169;
            --orange-badge: #d69e2e;
            --notification-count-bg: #e53e3e;
            --transition-speed: 0.3s;
        }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            margin: 0; padding: 0; background-color: var(--background-color); color: var(--text-color);
            line-height: 1.5;
        }

        /* Sidebar & Layout */
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--secondary-color); color: white; padding: 25px 15px; box-sizing: border-box; flex-shrink: 0; }
        .logo { font-size: 1.1em; font-weight: 700; margin-bottom: 40px; padding-left: 10px; display: flex; align-items: center; letter-spacing: 0.5px; }
        .logo-icon { margin-right: 12px; font-size: 2.0em; }
        
        .nav-link { 
            display: flex; align-items: center; padding: 12px 15px; color: #cbd5e0; text-decoration: none; 
            margin-bottom: 8px; border-radius: 8px; transition: all var(--transition-speed); position: relative;
        }
        .nav-link:hover { color: white; background-color: rgba(255,255,255,0.1); transform: translateX(5px); }
        .nav-link.active { color: white; background-color: var(--primary-color); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .nav-icon { margin-right: 12px; font-size: 1.1em; opacity: 0.8; }

        /* Main Content */
        .main-content { flex-grow: 1; padding: 30px 40px; }
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            background-color: var(--card-bg); padding: 15px 30px; border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 35px; 
        }

        /* Professional Profile Dropdown */
        .user-profile-container { position: relative; padding-bottom: 5px; cursor: pointer; }
        .user-profile { display: flex; align-items: center; font-weight: 500; font-size: 0.95rem; }
        .welcome-text span { color: var(--primary-color); font-weight: 600; margin-left: 4px; }
        
        .profile-dropdown {
            position: absolute; top: 110%; right: 0; background-color: white; min-width: 190px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-radius: 10px; display: none; 
            z-index: 1100; border: 1px solid var(--border-color); animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .profile-dropdown::before { content: ""; position: absolute; top: -15px; left: 0; width: 100%; height: 15px; background: transparent; }
        .user-profile-container:hover .profile-dropdown { display: block; }
        
        .dropdown-item { display: flex; align-items: center; padding: 12px 18px; text-decoration: none; color: var(--text-color); font-size: 0.9rem; transition: background 0.2s; }
        .dropdown-item:hover { background-color: #f7fafc; color: var(--primary-color); }
        .dropdown-divider { height: 1px; background-color: var(--border-color); margin: 6px 0; }

        /* Summary Cards */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .card { 
            background-color: var(--card-bg); padding: 25px; border-radius: 16px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
            border: 1px solid transparent;
        }
        .card:hover { transform: translateY(-8px); box-shadow: 0 12px 20px rgba(0,0,0,0.08); border-color: var(--border-color); }
        .card-body-flex { display: flex; align-items: stretch; gap: 20px; }
        .card-left { flex: 0 0 65%; display: flex; flex-direction: column; justify-content: center; }
        .card-right { flex: 0 0 35%; display: flex; align-items: center; justify-content: center; border-left: 1px solid var(--border-color); }
        
        .card-title-h2 { font-size: 1.1em; font-weight: 600; color: var(--text-light); margin: 0 0 15px 0; text-transform: uppercase; letter-spacing: 0.5px; }
        .card-count-huge { font-size: 3.5em; font-weight: 800; line-height: 1; }
        
        .progress-track { height: 10px; width: 100%; background-color: #edf2f7; border-radius: 20px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 20px; transition: width 1s cubic-bezier(0.1, 0, 0.1, 1); }

        /* Issues Table Styling */
        .recent-issues-section h2 { font-size: 1.4em; margin-bottom: 20px; font-weight: 700; color: var(--secondary-color); }
        .issues-table { background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        .issues-table thead { background-color: #f8fafc; border-bottom: 2px solid var(--border-color); }
        .issues-table th { padding: 18px 25px; text-align: left; color: var(--text-light); font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
        .issues-table td { padding: 18px 25px; border-bottom: 1px solid var(--border-color); font-size: 0.95rem; transition: background 0.2s; }
        .issues-table tr:last-child td { border-bottom: none; }
        .issues-table tbody tr:hover { background-color: #fcfcfd; }
        .issues-table tbody tr:hover td:first-child { box-shadow: inset 4px 0 0 var(--primary-color); }

        .status-pill { padding: 6px 14px; border-radius: 30px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }

        /* Notification Modal */
        .notification-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; 
            visibility: hidden; opacity: 0; transition: all 0.3s; z-index: 2000;
        }
        .notification-overlay.is-open { visibility: visible; opacity: 1; }
        .notification-popup {
            background: white; border-radius: 20px; width: 90%; max-width: 500px; max-height: 75vh; 
            display: flex; flex-direction: column; overflow: hidden; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .notification-overlay.is-open .notification-popup { transform: scale(1); }
        .popup-header { padding: 25px; font-size: 1.3rem; font-weight: 700; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; }
        .close-btn { cursor: pointer; color: var(--text-light); font-size: 1.5rem; line-height: 1; }
        
        .notification-item {
            display: flex; padding: 20px; border-bottom: 1px solid #f7fafc; text-decoration: none; color: inherit; transition: background 0.2s;
        }
        .notification-item:hover { background-color: #f0f7ff; }
        .notification-icon-box { background: var(--primary-color); color: white; border-radius: 12px; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; margin-right: 15px; flex-shrink: 0; }
        .notification-badge { background: var(--notification-count-bg); color: white; border-radius: 50%; padding: 2px 7px; font-size: 0.65rem; position: absolute; top: 10px; right: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">
                <span class="logo-icon">üè†</span>
                <div><div>Residential</div><div style="font-size: 0.7em; opacity: 0.7;">APARTMENTS</div></div>
            </div>
            <nav>
                <a href="{% url 'home' %}" class="nav-link active">
                    <span class="nav-icon">üìä</span> Dashboard
                </a>
                <a href="{% url 'report-issue' %}" class="nav-link"><span class="nav-icon">‚ùó</span> Raise an Issue</a>
                <a href="#" class="nav-link" onclick="event.preventDefault(); filterByVoting();">
                    <span class="nav-icon">üó≥Ô∏è</span> Voting
                </a>
                <a href="#" class="nav-link" onclick="event.preventDefault(); toggleNotifications();">
                    <span class="nav-icon">üîî</span>
                    {% if notifications|length > 0 %}<span class="notification-badge">{{ notifications|length }}</span>{% endif %}
                    Notifications
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="user-profile-container">
                    <div class="user-profile">
                        <span style="margin-right: 10px; opacity: 0.7;">üë§</span>
                        <div class="welcome-text">Hi, <span>{{ user_full_name }}</span> &nbsp;‚ñæ</div>
                    </div>
                    <div class="profile-dropdown">
                        <a href="#" class="dropdown-item"><span>üë§</span> My Profile</a>
                        <div class="dropdown-divider"></div>
                        <a href="{% url 'logout' %}" class="dropdown-item" style="color: #e53e3e;"><span>üö™</span> Sign Out</a>
                    </div>
                </div>
                <div class="header-icons">
                    <span class="header-icon-btn" onclick="toggleNotifications()" style="font-size: 1.2rem; cursor: pointer; position: relative;">
                        üîî {% if notifications|length > 0 %}<span class="notification-badge" style="top:-5px; right:-10px;">{{ notifications|length }}</span>{% endif %}
                    </span>
                </div>
            </header>

            <div class="summary-cards"> 
                <div class="card">
                    <div class="card-body-flex">
                        <div class="card-left">
                            <h2 class="card-title-h2">Open Issues</h2>
                            <div class="progress-track"><div class="progress-fill" style="width: {{ card_open_pct }}%; background-color: var(--blue-badge);"></div></div>
                        </div>
                        <div class="card-right"><div class="card-count-huge" style="color: var(--blue-badge);">{{ card_open_count }}</div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body-flex">
                        <div class="card-left">
                            <h2 class="card-title-h2">Resolved</h2>
                            <div class="progress-track"><div class="progress-fill" style="width: {{ card_resolved_pct }}%; background-color: var(--green-badge);"></div></div>
                        </div>
                        <div class="card-right"><div class="card-count-huge" style="color: var(--green-badge);">{{ card_resolved_count }}</div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body-flex">
                        <div class="card-left">
                            <h2 class="card-title-h2">Pending Votes</h2>
                            <div class="progress-track"><div class="progress-fill" style="width: {{ card_pending_pct }}%; background-color: var(--orange-badge);"></div></div>
                        </div>
                        <div class="card-right"><div class="card-count-huge" style="color: var(--orange-badge);">{{ card_pending_count }}</div></div>
                    </div>
                </div>
            </div>

            <section class="recent-issues-section">
                <h2>Recent Issues</h2>
                <div class="issues-table">
                    <table>
                        <thead>
                            <tr><th>Issue Description</th><th>Status</th><th>Reported By</th><th>Date</th></tr>
                        </thead>
                        <tbody>
                            {% for issue in recent_issues %}
                            <tr onclick="window.location='{% url 'issue_details' issue.id %}'" style="cursor: pointer;">
                                <td style="font-weight: 500;">{{ issue.title }}</td>
                                <td>
                                    <span class="status-pill" style="
                                        {% if issue.status == 'Resolved' %} background-color: #def7ec; color: #03543f; 
                                        {% elif issue.status == 'In Review' %} background-color: #fef3c7; color: #92400e; 
                                        {% else %} background-color: #e1effe; color: #1e429f; {% endif %}">
                                        {{ issue.status }}
                                    </span>
                                </td>
                                <td style="color: var(--text-light);">{{ issue.reported_by_id.full_name|default:issue.reported_by_id.email }}</td>
                                <td style="color: var(--text-light);">{{ issue.reported_date|date:"M d, Y" }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--text-light);">No issues reported yet.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Notification Overlay -->
    <div class="notification-overlay" id="notificationOverlay" onclick="if(event.target==this) toggleNotifications()">
        <div class="notification-popup" style="display: flex; flex-direction: column; overflow: hidden;">
            
            <!-- FIXED HEADER: Stays at the top -->
            <div class="popup-header" style="padding: 20px 24px; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.2rem; display: flex; align-items: center;">üîî</span>
                    <span style="font-weight: 700; color: var(--secondary-color); letter-spacing: -0.3px;">Notifications</span>
                </div>
                <span class="close-btn" onclick="toggleNotifications()" style="font-size: 1.8rem; line-height: 1; cursor: pointer; height: 30px; width: 30px; display: flex; align-items: center; justify-content: center;">&times;</span>
            </div>
            
            <!-- SCROLLABLE CONTENT: Only this part moves -->
            <div class="popup-content-scroll" style="padding: 0; overflow-y: auto; flex-grow: 1; max-height: calc(75vh - 70px);">
                {% for note in notifications %}
                <a href="{% if note.issue.id %}{% url 'issue_details' note.issue.id %}{% else %}#{% endif %}" 
                class="notification-item" 
                style="display: flex; align-items: flex-start; padding: 18px 24px; border-bottom: 1px solid #f1f5f9; transition: 0.2s; gap: 16px; text-decoration: none;">
                    
                    <div class="notification-icon-box" style="width: 42px; height: 42px; flex-shrink: 0; background: rgba(0, 74, 139, 0.05); color: var(--primary-color); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-top: 2px;">
                        {% if "Resolved" in note.title %}‚úÖ{% else %}‚ùó{% endif %}
                    </div>
                    
                    <div class="notification-content" style="flex-grow: 1; display: flex; flex-direction: column;">
                        <p style="margin: 0; font-weight: 700; font-size: 0.95rem; color: var(--secondary-color); line-height: 1.3;">{{ note.title }}</p>
                        <p style="margin: 4px 0 12px 0; color: var(--text-light); font-size: 0.88rem; line-height: 1.5;">{{ note.message }}</p>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 0.8rem; opacity: 0.5;">üë§</span>
                                <span style="color: var(--primary-color); font-size: 0.78rem; font-weight: 600;">
                                    {{ note.issue.reported_by_id.full_name|default:note.issue.reported_by_id.email }}
                                </span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 0.8rem; opacity: 0.5;">üïí</span>
                                <span style="font-size: 0.75rem; color: var(--text-light); font-weight: 500;">
                                    {{ note.time_since_created }}
                                </span>
                            </div>
                        </div>
                    </div>
                </a>
                {% empty %}
                <div style="padding: 80px 40px; text-align: center;">
                    <div style="width: 60px; height: 60px; background: #f7fafc; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                        <span style="font-size: 1.5rem; opacity: 0.4;">üì≠</span>
                    </div>
                    <p style="color: var(--text-light); font-size: 0.95rem; font-weight: 500;">No new notifications</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>


    <script>
        function toggleNotifications() {
            document.getElementById('notificationOverlay').classList.toggle('is-open');
        }
        function filterByVoting() {
            // 1. Get all table rows from the tbody
            const tableRows = document.querySelectorAll('.issues-table tbody tr');
            
            tableRows.forEach(row => {
                // 2. Find the status pill inside each row
                const statusPill = row.querySelector('.status-pill');
                
                if (statusPill) {
                    const statusText = statusPill.textContent.trim();
                    
                    // 3. Show only rows where status is "In Review"
                    if (statusText === "In Review") {
                        row.style.display = ""; // Visible
                    } else {
                        row.style.display = "none"; // Hidden
                    }
                }
            });

            // Optional: Highlight the "Voting" link as active
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

    </script>
</body>
</html>